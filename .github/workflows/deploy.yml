name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-west-1

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/arm64

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and push images
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_BACKEND_REPO: matcha-backend
          ECR_FRONTEND_REPO: matcha-frontend
        run: |
          chmod +x ./build-and-push.sh
          ./build-and-push.sh --deploy

      - name: Output image tags
        run: |
          echo "Backend: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/matcha-backend:latest"
          echo "Frontend: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/matcha-frontend:latest"

  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Backup database before deploy
        env:
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          # Run backup script before deployment
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["bash ~/backup-postgres.sh >> ~/backup.log 2>&1"]' \
            --query 'Command.CommandId' \
            --output text)

          # Wait for backup to complete (timeout 120s)
          echo "Waiting for backup to complete..."
          aws ssm wait command-executed \
            --instance-id "$INSTANCE_ID" \
            --command-id "$COMMAND_ID" || true

          # Check backup status
          STATUS=$(aws ssm get-command-invocation \
            --instance-id "$INSTANCE_ID" \
            --command-id "$COMMAND_ID" \
            --query 'Status' \
            --output text)

          if [ "$STATUS" != "Success" ]; then
            echo "::warning::Database backup returned status: $STATUS - check ~/backup.log on EC2"
          else
            echo "Database backup completed successfully"
          fi

      - name: Deploy to EC2 via SSM
        env:
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # Send command to EC2 via SSM
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'cd ~/matcha',
              'aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com',
              'docker-compose pull',
              'docker-compose down',
              'docker-compose up -d',
              'docker system prune -f'
            ]" \
            --output text
